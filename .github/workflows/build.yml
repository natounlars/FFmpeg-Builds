name: Ultimate win64-gpl FFmpeg

on:
  workflow_dispatch:          # 纯手动触发，避免滥用
  schedule:
    - cron: '0 16 * * 0'      # 每周日 16:00 UTC 自动编一份最新版

env:
  DOCKER_BUILDKIT: 1

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout upstream（
        uses: actions/checkout@v4
        with:
          repository: BtbN/FFmpeg-Builds
          path: .

      - name: 注入“顶配功能”构建参数
        run: |
          cat > scripts/ultimate-deps.sh <<'EOF'
          #!/bin/bash
          set -e
          if [[ -f /tmp/sdks.zip ]]; then
            unzip -q /tmp/sdks.zip -d /opt/sdks
          fi
          # 2. fdk-aac
          git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git
          cmake -B fdk-aac/build -G Ninja -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=$PREFIX
          ninja -C fdk-aac/build install
          # 3. whisper.cpp
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp.git
          cmake -B whisper.cpp/build -G Ninja -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=$PREFIX
          ninja -C whisper.cpp/build install
          # 4. aribb24 / aribcaption
          git clone --depth 1 https://github.com/nkoriyama/aribb24.git
          autoreconf -fi aribb24 && cd aribb24 && ./configure --prefix=$PREFIX --disable-shared && make install
          git clone --depth 1 https://github.com/nkoriyama/aribcaption.git
          cmake -B aribcaption/build -G Ninja -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=$PREFIX
          ninja -C aribcaption/build install
          EOF
          chmod +x scripts/ultimate-deps.sh

          cat >> scripts/variants/gpl-common.sh <<EOF
          EXTRA_CONFIGURE_FLAGS="\$EXTRA_CONFIGURE_FLAGS \
            --enable-libfdk-aac \
            --enable-decklink          --extra-cflags=-I/opt/sdks/DecklinkSDK/include --extra-ldflags=-L/opt/sdks/DecklinkSDK/lib \
            --enable-libndi_newtek     --extra-cflags=-I/opt/sdks/NDI/SDK/include     --extra-ldflags=-L/opt/sdks/NDI/SDK/lib \
            --enable-d3d12va \
            --enable-libshaderc        --extra-cflags=-I/usr/local/include --extra-ldflags=-L/usr/local/lib \
            --enable-libplacebo        --extra-cflags=-I/usr/local/include --extra-ldflags=-L/usr/local/lib \
            --enable-liblc3 \
            --enable-libaribb24 \
            --enable-libaribcaption \
            --enable-libwhisper"
          EOF

      - name:  登录 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: 拉取官方基础镜像（带缓存）
        run: |
          docker pull ghcr.io/btbn/ffmpeg-builds/base-win64:latest

      - name:  构建“ultimate”镜像（复用官方 Dockerfile，只换参数）
        run: |
          docker buildx build \
            --tag ghcr.io/${{ github.repository }}/ultimate-win64:latest \
            --cache-from ghcr.io/btbn/ffmpeg-builds/base-win64:cache \
            --build-arg VARIANT=gpl \
            --build-arg REPO=ghcr.io/${{ github.repository }} \
            --file images/base-win64/Dockerfile \
            --load \
            .
            
          docker run --rm \
            -v $PWD/scripts:/scripts \
            -e VARIANT=gpl \
            -e TARGET=win64 \
            ghcr.io/${{ github.repository }}/ultimate-win64:latest \
            bash -c "/scripts/ultimate-deps.sh && /scripts/build.sh gpl"

      - name:  收集产物
        run: |
          mkdir -p artifacts
          docker cp $(docker create ghcr.io/${{ github.repository }}/ultimate-win64:latest):/artifacts/. artifacts/
          ls -lh artifacts/

      - name:  上传成品（带日期标签）
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-ultimate-win64-${{ github.run_number }}
          path: artifacts/*.zip
          retention-days: 90
